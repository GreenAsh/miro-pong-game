<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="https://realtimeboard.com/app/static/rtb.uikit.css">
	<script src="https://realtimeboard.com/app/static/rtb.sdk.1.0.js"></script>

	<style>
		.rtb-sidebar-caption {
			font-size: 14px;
			font-weight: bold;
			color: rgba(0, 0, 0, 0.8);
			padding: 24px 0 0 24px;
		}

		.actions {
			padding: 20px 24px 0 24px;
		}

		button {
			height: 32px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: bold;
			line-height: 30px;
			text-align: center;
			color: #fff;
			min-width: 65px;
			background-color: #2a79ff;
			overflow: hidden;
			text-overflow: ellipsis;
		}
	</style>
	<script src="global.js"></script>
</head>

<body>
	<div class="rtb-sidebar-caption">Ping-pong</div>
	<div class="actions">
		<center>
			<br><br>
			<button onclick="run()" style="width: 120px;">Play!</button>
			<br><br>
			<h2 id="controls" style="display:none;">Use up/down arrows and A/Z keys to control pad</h2>
			<h2 id="you-are-dead" style="display:none; background-color: red;">You are dead, reopen sidebar and click 'Play'!</h2>
			<h2 id="click-for-focus" style="display:none;">Click on sidebar <br>to control pad</h2>
		</center>
	</div>
	<script>
		'use strict'

		async function setUp() {
			const promises = []

			let data
			for (let x = 0; x < gridInit[0].length; x++) {
				for (let y = 0; y < gridInit.length; y++) {
					if (promises[y] == undefined) {
						promises[y] = []
					}
					switch (gridInit[y][x]) {
						case 0:
							data = blockDraft
							break
					}
					promises[y][x] = rtb.board.widgets.shapes.create(Object.assign({},
						data,
						{
							x: BLOCK_STEP * x,
							y: BLOCK_STEP * y
						}
					))
				}
			}

			for (let x = 0; x < promises[0].length; x++) {
				for (let y = 0; y < promises.length; y++) {
					if (brickWidgets[y] == undefined) {
						brickWidgets[y] = []
					}
					brickWidgets[y][x] = await promises[y][x]
				}
			}

			spawnPad()
			spawnBall()
			spawnFrames()
		}

		async function spawnPad() {
			currentPlayer.widget = await rtb.board.widgets.shapes.create(Object.assign({},
				padDraft,
				{
					x: BLOCK_STEP * Math.floor(gridInit[0].length / 2),
					y: BLOCK_STEP * 14
				}
			))
		}

		async function spawnBall() {
			ball.widget = await rtb.board.widgets.shapes.create(Object.assign({},
				ballDraft,
				{
					x: BLOCK_STEP * Math.floor(gridInit[0].length / 2),
					y: BLOCK_STEP * 13
				}
			))
		}

		async function spawnFrames() {
			upFrameWidget = await rtb.board.widgets.shapes.create(Object.assign({},
				horizontalFrame,
				{
					x: BLOCK_STEP * gridInit[0].length / 2 - BLOCK_STEP / 2,
					y: - BLOCK_STEP
				}
			))
			downFrameWidget = await rtb.board.widgets.shapes.create(Object.assign({},
				horizontalFrame,
				{
					x: BLOCK_STEP * gridInit[0].length / 2 - BLOCK_STEP / 2,
					y: BLOCK_STEP * 15
				}
			))
			leftFrameWidget = await rtb.board.widgets.shapes.create(Object.assign({},
				verticalFrame,
				{
					x: - BLOCK_STEP,
					y: BLOCK_STEP * 7
				}
			))
			rightFrameWidget = await rtb.board.widgets.shapes.create(Object.assign({},
				verticalFrame,
				{
					x: BLOCK_STEP * gridInit[0].length,
					y: BLOCK_STEP * 7
				}
			))
		}

		async function run() {
			setUp()

			window.addEventListener('keydown', (e) => {
				switch (e.keyCode) {
					case 37:
						movePad('left')
						break
					case 39:
						movePad('right')
						break
				}
				e.preventDefault()
				e.stopPropagation()
			})

			requestAnimationFrame(tick)

			function tick() {
				requestAnimationFrame(tick)
			}
		}

		function waitMilliseconds(ms) {
			return new Promise((resolve) => {
				setTimeout(resolve, ms)
			})
		}

		function movePad(direction) {
			console.log(direction)
		}
	</script>
</body>

</html>